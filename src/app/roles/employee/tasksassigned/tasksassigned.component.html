<div class="user-management-tab">
    <div class="user-stats-grid">
        @for (item of stats; track item.label) {
        <div class="stat-card">
            <div class="stat-info">
                <span class="label">{{ item.label }}</span>
                <h2 class="value">{{ item.value }}</h2>
            </div>
            <div class="stat-icon" [ngClass]="item.class">
                <i [class]="item.icon"></i>
            </div>
        </div>
        }
    </div>
 
    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
        <button
            class="tab-button"
            [class.active]="activeTab === 'My Tasks'"
            (click)="activeTab = 'My Tasks'">
            <i class="fas fa-tasks"></i> My Tasks
        </button>
        <button
            class="tab-button"
            [class.active]="activeTab === 'Approvals'"
            (click)="activeTab = 'Approvals'">
            <i class="fas fa-check-circle"></i> Approvals
        </button>
    </div>
 
    <!-- My Tasks Tab -->
    @if (activeTab === 'My Tasks') {
    <div class="user-management-section">
        <h3 class="title">My Tasks</h3>
 
        <!-- Loading State -->
        @if (isLoadingTasks) {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading tasks...</p>
        </div>
        }
 
        <!-- Task List using *ngFor -->
        <div class="task-list" *ngIf="!isLoadingTasks">
            <div class="task-item" *ngFor="let task of getMyActiveTasks()">
                <div class="task-header">
                    <div class="task-info">
                        <span class="task-name">
                            <i [ngClass]="{
                                'fa-regular fa-circle-check icon-green': task.status === 'Completed',
                                'fa-regular fa-clock icon-blue': task.status === 'In Progress',
                                'fa-solid fa-play icon-gray': task.status === 'Pending'
                            }"></i>
                            {{ task.title }}
                        </span>
                        <span class="task-id">Task #{{ task.taskId }}</span>
                    </div>
                    <div class="task-meta">
                        <!-- Status badge with conditional CSS class -->
                        <span class="badge" [ngClass]="{
                            'bg-success': task.status === 'Completed',
                            'bg-warning text-dark': task.status === 'In Progress',
                            'bg-secondary': task.status === 'Pending'
                        }">{{ task.status }}</span>
                        <!-- Rejected badge if task was rejected -->
                        @if (task.isRejected) {
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle"></i> Needs Revision
                        </span>
                        }
                        <!-- Priority badge -->
                        <span class="badge" [ngClass]="{
                            'bg-danger': task.priority === 'High',
                            'bg-warning text-dark': task.priority === 'Medium',
                            'bg-success': task.priority === 'Low'
                        }">{{ task.priority }}</span>
                    </div>
                </div>
                <div class="task-description">
                    {{ task.description }}
                </div>
                @if (task.isRejected && task.rejectionReason) {
                <div class="alert alert-danger mt-2 mb-2" style="font-size: 0.875rem;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Manager's Feedback:</strong>
                    <p class="mb-0 mt-1">{{ task.rejectionReason }}</p>
                    <small class="text-muted mt-1 d-block"><strong>Action Required:</strong> Please address this feedback and complete the task again.</small>
                </div>
                }
                <div class="task-details">
                    <span><i class="fas fa-hourglass"></i> Est: {{ task.estimatedHours || 0 }}h</span>
                    @if (task.actualHours) {
                    <span><i class="fas fa-clock"></i> Actual: {{ task.actualHours }}h</span>
                    }
                    <span *ngIf="task.dueDate"><i class="fas fa-calendar"></i> {{ task.dueDate | date: 'MMM dd, yyyy' }}</span>
                    @if (task.isOverdue) {
                    <span class="badge bg-danger text-white"><i class="fas fa-exclamation-triangle"></i> OVERDUE</span>
                    }
                    @if (task.daysUntilDue !== undefined && task.daysUntilDue <= 3 && task.daysUntilDue > 0 && !task.isOverdue) {
                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Due in {{ task.daysUntilDue }} days</span>
                    }
                </div>
                <!-- Progress Bar: Estimated vs Actual Hours -->
                @if (task.estimatedHours && task.actualHours !== undefined) {
                <div class="progress-container">
                    <div class="progress-info">
                        <span>Hours Progress: {{ task.actualHours }} / {{ task.estimatedHours }} ({{ (task.actualHours / task.estimatedHours * 100) | number:'1.0-0' }}%)</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" 
                          [ngClass]="{
                            'bg-danger': (task.actualHours / task.estimatedHours) > 1.2,
                            'bg-warning': (task.actualHours / task.estimatedHours) > 1 && (task.actualHours / task.estimatedHours) <= 1.2,
                            'bg-success': (task.actualHours / task.estimatedHours) <= 1
                          }"
                          [style.width.%]="(task.actualHours / task.estimatedHours * 100 > 100 ? 100 : task.actualHours / task.estimatedHours * 100)"></div>
                    </div>
                </div>
                } @else {
                <div class="progress-container">
                    <div class="progress-info">
                        <span>Task Progress</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" [style.width.%]="getProgressPercentage(task.status)"></div>
                    </div>
                </div>
                }
                <div class="task-actions">
                    <!-- Start Button (only for Pending tasks) -->
                    <button
                        class="btn-start-task"
                        (click)="onStartTask(task)"
                        [disabled]="task.status !== 'Pending' && task.canStart === false"
                        [title]="task.status !== 'Pending' ? 'Task already started or completed' : 'Click to start this task'">
                        <i class="fas fa-play-circle"></i> Start
                    </button>

                    <!-- Complete Button (only for In Progress tasks) -->
                    <button
                        class="btn-complete-task"
                        (click)="openCompletionModalFromTask(task)"
                        [disabled]="(task.status !== 'InProgress' && task.status !== 'In Progress') || task.canComplete === false"
                        [title]="task.status === 'InProgress' || task.status === 'In Progress' ? 'Click to mark as completed' : 'Task must be started first'">
                        <i class="fas fa-check-circle"></i> Complete
                    </button>
                </div>
            </div>
 
            <!-- Empty State -->
            <div class="no-tasks-message" *ngIf="getMyActiveTasks().length === 0">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p>No active tasks!</p>
                <small class="text-muted">Tasks assigned to you will appear here.</small>
            </div>
        </div>
    </div>
    }

    <!-- Approvals Tab -->
    @if (activeTab === 'Approvals') {
    <div class="user-management-section">
        <h3 class="title">Task Approvals</h3>

        <div class="task-list">
            @for (task of getApprovalTasks(); track task.taskId || task.id) {
            <div class="task-item">
                <div class="task-header">
                    <div class="task-info">
                        <span class="task-name">
                            <i [ngClass]="{
                                'fa-solid fa-check-circle icon-green': task.status === 'Approved',
                                'fa-regular fa-clock icon-warning': task.status === 'Completed',
                                'fa-solid fa-times-circle icon-red': task.isRejected
                            }"></i>
                            {{ task.title }}
                        </span>
                        <span class="task-id">Task #{{ task.taskId }}</span>
                    </div>
                    <div class="task-meta">
                        @if (task.status === 'Completed') {
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock"></i> Awaiting Approval
                        </span>
                        } @else if (task.status === 'Approved') {
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Approved
                        </span>
                        } @else if (task.isRejected) {
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle"></i> Rejected
                        </span>
                        }
                        <span class="badge" [ngClass]="{
                            'bg-danger': task.priority === 'High',
                            'bg-warning text-dark': task.priority === 'Medium',
                            'bg-success': task.priority === 'Low'
                        }">{{ task.priority }}</span>
                    </div>
                </div>
                <div class="task-description">
                    {{ task.description }}
                </div>
                @if (task.isRejected && task.rejectionReason) {
                <div class="alert alert-danger mt-2 mb-2" style="font-size: 0.875rem;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Rejection Reason:</strong>
                    <p class="mb-0 mt-1">{{ task.rejectionReason }}</p>
                    <small class="text-muted mt-1 d-block">Please address this feedback and complete the task again.</small>
                </div>
                }
                <div class="task-details">
                    <span><i class="fas fa-hourglass"></i> Est: {{ task.estimatedHours || 0 }}h</span>
                    @if (task.actualHours) {
                    <span><i class="fas fa-clock"></i> Actual: {{ task.actualHours }}h</span>
                    }
                    @if (task.completedDate) {
                    <span><i class="fas fa-calendar-check"></i> Completed: {{ task.completedDate | date: 'MMM dd, yyyy' }}</span>
                    }
                    @if (task.approvedDate) {
                    <span><i class="fas fa-check"></i> Approved: {{ task.approvedDate | date: 'MMM dd, yyyy' }}</span>
                    }
                    @if (task.approvedByUserName) {
                    <span><i class="fas fa-user-check"></i> By: {{ task.approvedByUserName }}</span>
                    }
                </div>
            </div>
            }

            <!-- Empty State -->
            @if (getApprovalTasks().length === 0) {
            <div class="no-tasks-message">
                <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                <p>No approval history</p>
                <small class="text-muted">Completed tasks will appear here for approval tracking.</small>
            </div>
            }
        </div>
    </div>
    }

    <!-- Task Completion Modal -->
    @if (showSubmissionModal && selectedTask) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Mark Task as Completed</h2>
                <button class="modal-close" (click)="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
 
            <div class="modal-body">
                <!-- Task Info -->
                <div class="task-submission-info">
                    <div class="info-row">
                        <strong>Task:</strong>
                        <span>{{ selectedTask.name }}</span>
                    </div>
                    <div class="info-row">
                        <strong>Task ID:</strong>
                        <span>#{{ selectedTask.taskId }}</span>
                    </div>
                    <div class="info-row">
                        <strong>Priority:</strong>
                        <span [class]="'badge ' + getPriorityClass(selectedTask.priority)">
                            {{ selectedTask.priority }}
                        </span>
                    </div>
                    <div class="info-row">
                        <strong>Total Hours:</strong>
                        <span>{{ selectedTask.totalHours }} hours</span>
                    </div>
                </div>
 
                <!-- Task Completion Form -->
                <form class="submission-form">
                    <div class="form-group">
                        <label for="hoursSpent">Hours Spent</label>
                        <input
                            id="hoursSpent"
                            type="number"
                            [(ngModel)]="submissionForm.hoursSpent"
                            name="hoursSpent"
                            class="form-control"
                            min="0"
                            step="0.5"
                            placeholder="Enter hours spent on this task">
                    </div>
 
                    <div class="form-group">
                        <label for="comments">Completion Comments (Optional)</label>
                        <textarea
                            id="comments"
                            [(ngModel)]="submissionForm.comments"
                            name="comments"
                            class="form-control"
                            rows="4"
                            placeholder="Add any comments about task completion..."></textarea>
                    </div>
                </form>
            </div>
 
            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
                <button class="btn btn-primary" (click)="onCompleteTask()">
                    <i class="fas fa-check"></i> Mark Completed
                </button>
            </div>
        </div>
    </div>
    }
</div>
 