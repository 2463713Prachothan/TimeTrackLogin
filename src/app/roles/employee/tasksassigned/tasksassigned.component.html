<div class="user-management-tab">
    <div class="user-stats-grid">
        @for (item of stats; track item.label) {
        <div class="stat-card">
            <div class="stat-info">
                <span class="label">{{ item.label }}</span>
                <h2 class="value">{{ item.value }}</h2>
            </div>
            <div class="stat-icon" [ngClass]="item.class">
                <i [class]="item.icon"></i>
            </div>
        </div>
        }
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
        <button 
            class="tab-button" 
            [class.active]="activeTab === 'My Tasks'"
            (click)="activeTab = 'My Tasks'">
            <i class="fas fa-tasks"></i> My Tasks
        </button>
        <button 
            class="tab-button" 
            [class.active]="activeTab === 'Submissions'"
            (click)="activeTab = 'Submissions'">
            <i class="fas fa-paper-plane"></i> My Submissions
        </button>
    </div>

    <!-- My Tasks Tab -->
    @if (activeTab === 'My Tasks') {
    <div class="user-management-section">
        <h3 class="title">My Tasks</h3>

        <!-- Loading State -->
        @if (isLoadingTasks) {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading tasks...</p>
        </div>
        }

        <!-- Task List using *ngFor -->
        <div class="task-list" *ngIf="!isLoadingTasks">
            <div class="task-item" *ngFor="let task of assignedTasks">
                <div class="task-header">
                    <div class="task-info">
                        <span class="task-name">
                            <i [ngClass]="{
                                'fa-regular fa-circle-check icon-green': task.status === 'Completed',
                                'fa-regular fa-clock icon-blue': task.status === 'In Progress',
                                'fa-solid fa-play icon-gray': task.status === 'Pending'
                            }"></i> 
                            {{ task.title }}
                        </span>
                        <span class="task-id">#{{ task.displayTaskId || task.taskId }}</span>
                    </div>
                    <div class="task-meta">
                        <!-- Status badge with conditional CSS class -->
                        <span class="badge" [ngClass]="{
                            'bg-success': task.status === 'Completed',
                            'bg-warning text-dark': task.status === 'In Progress',
                            'bg-secondary': task.status === 'Pending'
                        }">{{ task.status }}</span>
                        <!-- Priority badge -->
                        <span class="badge" [ngClass]="{
                            'bg-danger': task.priority === 'High',
                            'bg-warning text-dark': task.priority === 'Medium',
                            'bg-success': task.priority === 'Low'
                        }">{{ task.priority }}</span>
                    </div>
                </div>
                <div class="task-description">
                    {{ task.description }}
                </div>
                <div class="task-details">
                    <span><i class="fas fa-hourglass"></i> {{ task.estimatedHours || 0 }} hours</span>
                    <span *ngIf="task.dueDate"><i class="fas fa-calendar"></i> {{ task.dueDate | date: 'MMM dd, yyyy' }}</span>
                </div>
                <div class="progress-container">
                    <div class="progress-info">
                        <span>Progress</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" [style.width.%]="getProgressPercentage(task.status)"></div>
                    </div>
                </div>
                <button 
                    class="btn-submit-task"
                    (click)="openSubmissionModalFromTask(task)"
                    [disabled]="task.status === 'Completed'">
                    <i class="fas fa-check-circle"></i> Submit Completion
                </button>
            </div>

            <!-- Empty State -->
            <div class="no-tasks-message" *ngIf="assignedTasks.length === 0">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p>No tasks assigned yet!</p>
                <small class="text-muted">Tasks assigned to you will appear here.</small>
            </div>
        </div>
    </div>
    }

    <!-- Submissions Tab -->
    @if (activeTab === 'Submissions') {
    <div class="user-management-section">
        <h3 class="title">My Task Submissions</h3>

        @if (submissionHistory.length > 0) {
        <div class="submissions-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Task ID</th>
                        <th>Submitted</th>
                        <th>Status</th>
                        <th>Completion</th>
                        <th>Hours</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    @for (submission of submissionHistory; track submission.id) {
                    <tr>
                        <td>{{ submission.taskTitle }}</td>
                        <td><span class="task-id-badge">#{{ submission.taskId }}</span></td>
                        <td>{{ submission.submittedDate | date: 'MMM dd, yyyy HH:mm' }}</td>
                        <td>
                            <span [class]="'badge ' + getSubmissionStatusClass(submission.approvalStatus)">
                                {{ submission.approvalStatus }}
                            </span>
                        </td>
                        <td>
                            <span [class]="'badge ' + getCompletionStatusClass(submission.completionStatus)">
                                {{ submission.completionStatus }}
                            </span>
                        </td>
                        <td>{{ submission.hoursSpent }} hrs</td>
                        <td class="comments-cell">
                            {{ submission.comments || '-' }}
                            @if (submission.approvalComments) {
                            <div class="approval-comment">
                                <strong>Manager:</strong> {{ submission.approvalComments }}
                            </div>
                            }
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        } @else {
        <div class="no-submissions-message">
            <i class="fas fa-paper-plane"></i>
            <p>No task submissions yet</p>
        </div>
        }
    </div>
    }

    <!-- Task Submission Modal -->
    @if (showSubmissionModal && selectedTask) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Submit Task Completion</h2>
                <button class="modal-close" (click)="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <!-- Task Info -->
                <div class="task-submission-info">
                    <div class="info-row">
                        <strong>Task:</strong>
                        <span>{{ selectedTask.name }}</span>
                    </div>
                    <div class="info-row">
                        <strong>Task ID:</strong>
                        <span>#{{ selectedTask.taskId }}</span>
                    </div>
                    <div class="info-row">
                        <strong>Priority:</strong>
                        <span [class]="'badge ' + getPriorityClass(selectedTask.priority)">
                            {{ selectedTask.priority }}
                        </span>
                    </div>
                    <div class="info-row">
                        <strong>Total Hours:</strong>
                        <span>{{ selectedTask.totalHours }} hours</span>
                    </div>
                </div>

                <!-- Submission Form -->
                <form class="submission-form">
                    <div class="form-group">
                        <label for="completionStatus">Completion Status</label>
                        <select 
                            id="completionStatus"
                            [(ngModel)]="submissionForm.completionStatus"
                            name="completionStatus"
                            class="form-control">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hoursSpent">Hours Spent</label>
                        <input 
                            id="hoursSpent"
                            type="number" 
                            [(ngModel)]="submissionForm.hoursSpent"
                            name="hoursSpent"
                            class="form-control"
                            min="0"
                            step="0.5"
                            placeholder="Enter hours spent">
                    </div>

                    <div class="form-group">
                        <label for="priority">Priority</label>
                        <select 
                            id="priority"
                            [(ngModel)]="submissionForm.priority"
                            name="priority"
                            class="form-control">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="comments">Comments</label>
                        <textarea 
                            id="comments"
                            [(ngModel)]="submissionForm.comments"
                            name="comments"
                            class="form-control"
                            rows="4"
                            placeholder="Add any comments about the task completion..."></textarea>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
                <button class="btn btn-primary" (click)="submitTaskCompletion()">
                    <i class="fas fa-paper-plane"></i> Submit
                </button>
            </div>
        </div>
    </div>
    }
</div>